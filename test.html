<!DOCTYPE html>
<html>

<head>
    <title>Test Scene</title>
    <meta charset="UTF-8">

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.misc.min.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.3/dist/super-hands.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.js"></script>
    <script
        src="https://unpkg.com/aframe-aabb-collider-component@3.1.0/dist/aframe-aabb-collider-component.min.js"></script>
</head>

<script src="helper_functions.js"></script>
<script>
    let gameTime = 30;
    let timer;
    let timeToSpawn = randomRange(2, 10);
    let fruitModels = ['assets/fruits/apple_vertical.gltf'];

    AFRAME.registerComponent('thumbstick', {
        init: function () {
            this.el.addEventListener('thumbstickmoved', this.logThumbstick);
        },
        logThumbstick: function (evt) {
            if (evt.detail.y > 0.95) { console.log("DOWN"); }
            if (evt.detail.y < -0.95) { console.log("UP"); }
            if (evt.detail.x < -0.95) { console.log("LEFT"); }
            if (evt.detail.x > 0.95) { console.log("RIGHT"); }
        }
    });

    AFRAME.registerComponent("fruitgenerator", {
        init: function () {
        },
        tick: function () {
            if (timeToSpawn <= 0) {
                generateFruit(this.el);
                timeToSpawn = randomRange(2, 5);
            }
        },

    });

    function generateFruit(element) {
        let scene = document.querySelector("#scene");
        let newFruit = document.createElement('a-sphere');

        newFruit.setAttribute('gltf-model', fruitModels[Math.floor(Math.random() * fruitModels.length)]);
        newFruit.setAttribute('scale', '0.35 0.35 0.35 ');
        newFruit.setAttribute('rotation', `${Math.random() * 180} ${Math.random() * 180} ${Math.random() * 180}`);

        let newX = Math.random() * 2 - 1;
        newFruit.setAttribute("position", `${newX} 2 -14`);
        newFruit.setAttribute("velocity", `${randomRange(-1, 1)} ${randomRange(1, 3)} 13`);
        scene.appendChild(newFruit);
        newFruit.setAttribute("dynamic-body", "shape:sphere; sphereRadius: 0.25");
        newFruit.setAttribute('sound','src:#slice; autoplay: false');

        newFruit.addEventListener('collide', function (e) {
            newFruit.setAttribute('visible', 'false');
            if(e.detail.body.id == document.querySelector('#heldKatana').body.id){
                newFruit.components.sound.playSound();
                console.log('Fruit has collided sword.')
            }
        });

    }

    AFRAME.registerComponent("worldkatana", {
        init: function () {
            let scene = document.querySelector("#scene");
            let handKatana = document.querySelector('#heldKatana');
            let worldKatana = document.querySelector('#worldKatana');

            this.el.addEventListener("grab-start", function () {
                handKatana.setAttribute("visible", "true");
                worldKatana.setAttribute("visible", "false");
                timer = setInterval(function () {
                    timeToSpawn--;
                }, 1000);
            })
        },
    });
</script>

<body>
    <a-scene id="scene" physics="friction: 0.5; restitution: 0.5; gravity: -5;">
        <a-assets>
            <audio id="slice" src="assets/slice.mp3" preload="auto"></audio>
        </a-assets>
        <a-entity id="rig">
            <a-camera look-controls wasd-controls></a-camera>

            <a-entity super-hands grab id="leftHand" hand-controls="hand: left;" thumb-controls="hand: left"
                static-body="shape: sphere; sphereRadius: 0.02;" sphere-collider="objects: .interactable"
                rotation="20 0 0"></a-entity>

            <a-entity super-hands grab id="rightHand" hand-controls="hand: right;" thumb-controls="hand: right"
                static-body="shape: sphere; sphereRadius: 0.02;" sphere-collider="objects: .interactable"
                rotation="-80 0 0">
                <a-entity id="heldKatana" position="-0.025 0.12 -0.47" scale="0.35 0.35 0.35" rotation="75 180 0"
                    visible="false" body="type: static; mass: 5; shape: none;" shape__main="shape: box;
                         halfExtents: 0.15 1.65 0.15;">
                    <a-entity gltf-model="assets/katana/katana.gltf" position="0 -1.5 0"></a-entity>
                </a-entity>
            </a-entity>
        </a-entity>

        <a-plane color="grey" rotation="-90 0 0" scale="20 20 20" static-body></a-plane>
        <a-entity fruitgenerator position="0 0 0"></a-entity>
        <a-entity worldkatana grabbable class="interactable" id="worldKatana" position="0 1 -0.5" rotation="0 180 90"
            geometry="primitive: box; width: 0.1; height: 1; depth: 0.1">
            <a-entity gltf-model="assets/katana/katana.gltf" scale="0.35 0.35 0.35" position="0 -0.5 0"></a-entity>
        </a-entity>
</body>

</html>